# 社交媒体评论情感分析算法文档

## 📋 概述

本模块实现了多种情感分析方法，用于分析社交媒体评论的情感倾向。支持正向、中性、负向三种情感分类，并提供置信度评估。

## 🏗️ 架构设计

### 核心组件

1. **SentimentAnalyzer** - 情感分析器基类
2. **DictionaryBasedAnalyzer** - 基于词典的分析器
3. **BaiduNLPAnalyzer** - 百度NLP API分析器
4. **TencentCloudAnalyzer** - 腾讯云API分析器
5. **DeepSeekAnalyzer** - DeepSeek API分析器
6. **AliyunNLPAnalyzer** - 阿里云NLP API分析器
7. **SentimentAnalysisManager** - 分析管理器

### 类图结构

```
SentimentAnalyzer (基类)
├── DictionaryBasedAnalyzer
├── BaiduNLPAnalyzer
├── TencentCloudAnalyzer
├── DeepSeekAnalyzer
└── AliyunNLPAnalyzer

SentimentAnalysisManager (管理器)
└── 管理各种分析器实例
```

## 🔧 算法详解

### 1. 词典匹配算法

#### 1.1 情感词典构建

**正向情感词**：
- 基础词：好、棒、赞、优秀、完美、精彩
- 情感词：喜欢、爱、支持、推荐、满意、开心
- 网络用语：666、牛、神、绝了、无敌、爆赞

**负向情感词**：
- 基础词：差、烂、垃圾、糟糕、恶心、讨厌
- 情感词：恨、烦、生气、愤怒、失望、伤心
- 网络用语：坑、骗、假、水、无聊、没意思

**中性情感词**：
- 一般、还行、凑合、普通、正常、标准
- 可以、不错、还好、马马虎虎、过得去

#### 1.2 否定词处理

```python
negation_words = {
    '不', '没', '无', '非', '未', '别', '莫', '勿', '毋', '弗', '否', '反',
    '不是', '没有', '无', '不', '别', '莫', '勿', '毋', '弗', '否', '反'
}
```

**否定规则**：
- 检测情感词前3个位置内的否定词
- 否定词会将情感极性反转
- 支持多重否定（负负得正）

#### 1.3 程度副词处理

```python
intensifier_words = {
    '非常': 2.0, '特别': 2.0, '极其': 2.0, '十分': 2.0, '很': 1.5, '挺': 1.3,
    '比较': 1.2, '有点': 0.8, '稍微': 0.7, '略微': 0.7, '太': 1.8, '真': 1.5
}
```

**程度规则**：
- 检测情感词前2个位置内的程度副词
- 程度副词会放大或缩小情感强度
- 支持多重程度修饰

#### 1.4 情感得分计算

```python
def calculate_sentiment_score(self, text: str) -> float:
    total_score = 0.0
    
    for i, word in enumerate(words):
        if word in self.sentiment_dict:
            score = self.sentiment_dict[word]
            
            # 否定词效果
            negation_effect = 1.0
            for j in range(max(0, i-3), i):
                if words[j] in self.negation_words:
                    negation_effect *= -1
            
            # 程度副词效果
            intensifier_effect = 1.0
            for j in range(max(0, i-2), i):
                if words[j] in self.intensifier_words:
                    intensifier_effect *= self.intensifier_words[words[j]]
            
            total_score += score * negation_effect * intensifier_effect
    
    # 归一化处理
    return total_score / len(words) if len(words) > 0 else 0.0
```

#### 1.5 情感分类阈值

```python
thresholds = {
    'positive': 0.3,   # 正向阈值
    'negative': -0.3   # 负向阈值
}
```

**分类规则**：
- score ≥ 0.3 → 正向
- score ≤ -0.3 → 负向
- -0.3 < score < 0.3 → 中性

### 2. API集成算法

#### 2.1 阿里云NLP API

**服务概述**：
根据[阿里云官方文档](https://help.aliyun.com/document_detail/179345.html)，阿里云NLP情感分析（基础版-通用领域）服务针对带有主观描述的自然语言文本，可自动判断该文本的情感正负倾向并给出相应的结果。

**接口信息**：
- **接口名称**: GetSaChGeneral
- **服务代码**: alinlp
- **支持语言**: 中文
- **支持领域**: 通用领域
- **文本长度**: 不超过1000字符
- **接口地址**: `https://alinlp.cn-hangzhou.aliyuncs.com/`

**认证方式**：
- AccessKey ID 和 AccessKey Secret
- HMAC-SHA1 签名认证
- 支持多种地域节点

**签名算法**：
```python
def _generate_signature(self, method: str, path: str, params: Dict, headers: Dict) -> str:
    # 构建规范化请求字符串
    canonicalized_query_string = "&".join([f"{k}={v}" for k, v in sorted(params.items())])
    canonicalized_headers = "&".join([f"{k.lower()}:{v}" for k, v in sorted(headers.items())])
    
    string_to_sign = f"{method}\n{path}\n{canonicalized_query_string}\n{canonicalized_headers}"
    
    # 使用HMAC-SHA1计算签名
    signature = base64.b64encode(
        hmac.new(
            self.access_key_secret.encode('utf-8'),
            string_to_sign.encode('utf-8'),
            hashlib.sha1
        ).digest()
    ).decode('utf-8')
    
    return signature
```

**请求参数**：
```python
request_params = {
    'Action': 'SentimentAnalysis',
    'Version': '2018-04-08',
    'Format': 'JSON',
    'Timestamp': datetime.utcnow().strftime('%Y-%m-%dT%H:%M:%SZ'),
    'SignatureMethod': 'HMAC-SHA1',
    'SignatureVersion': '1.0',
    'SignatureNonce': str(int(time.time() * 1000)),
    'AccessKeyId': access_key_id,
    'Text': text,
    'ServiceCode': 'alinlp'
}
```

**结果处理**：
```python
# 解析阿里云返回结果
if 'Data' in result and 'Sentiment' in result['Data']:
    sentiment_data = result['Data']['Sentiment']
    
    sentiment_mapping = {
        'positive': SentimentType.POSITIVE.value,
        'negative': SentimentType.NEGATIVE.value,
        'neutral': SentimentType.NEUTRAL.value
    }
    
    sentiment = sentiment_mapping.get(sentiment_data.get('Sentiment', ''), SentimentType.NEUTRAL.value)
    score = sentiment_data.get('Score', 0.0)
    confidence = sentiment_data.get('Confidence', 0.0)
```

**优势特点**：
- 基于海量大数据训练
- 支持多语言分析
- 高精度情感识别
- 企业级服务稳定性
- 丰富的行业应用场景

#### 2.2 百度NLP API

**接口地址**：`https://aip.baidubce.com/rpc/2.0/nlp/v1/sentiment_classify`

**认证流程**：
1. 获取access_token
2. 使用token调用情感分析接口
3. 解析返回的概率分布

**结果处理**：
```python
# 计算情感得分
score = positive_prob - negative_prob

# 确定情感类型
if positive_prob > 0.6:
    sentiment = "positive"
elif negative_prob > 0.6:
    sentiment = "negative"
else:
    sentiment = "neutral"
```

#### 2.2 DeepSeek API

**接口地址**：`https://api.deepseek.com/v1/chat/completions`

**Prompt设计**：
```
请分析以下文本的情感倾向，只返回JSON格式结果：
文本：{text}

请返回格式：
{
    "sentiment": "positive/neutral/negative",
    "score": 0.0-1.0之间的数值,
    "confidence": 0.0-1.0之间的置信度
}
```

**结果解析**：
- 解析JSON响应
- 验证格式正确性
- 提取情感信息

### 3. 置信度计算

#### 3.1 词典分析置信度

```python
def calculate_confidence(self, score: float) -> float:
    abs_score = abs(score)
    if abs_score >= 0.5:
        return min(0.95, 0.7 + abs_score * 0.5)
    elif abs_score >= 0.2:
        return 0.5 + abs_score * 0.4
    else:
        return 0.3 + abs_score * 0.4
```

**置信度规则**：
- 得分绝对值越大，置信度越高
- 最高置信度限制在0.95
- 最低置信度不低于0.3

#### 3.2 API分析置信度

- **阿里云NLP**：直接使用API返回的置信度
- **百度NLP**：使用最大概率值作为置信度
- **DeepSeek**：直接使用API返回的置信度

## 📊 数据流程

### 1. 数据输入

```python
# 从数据库获取评论
query = """
SELECT id, content, user_id, created_time, platform, likes_count
FROM comments 
WHERE created_time BETWEEN %s AND %s
ORDER BY created_time DESC
LIMIT %s
"""
```

### 2. 文本预处理

```python
def preprocess_text(self, text: str) -> str:
    # 去除特殊字符，保留中文、英文、数字
    text = re.sub(r'[^\u4e00-\u9fa5a-zA-Z0-9\s]', '', text)
    # 去除多余空白
    text = re.sub(r'\s+', ' ', text).strip()
    return text
```

### 3. 情感分析

```python
# 分析单个文本
result = analyzer.analyze_sentiment(text)

# 批量分析
results = manager.analyze_batch(texts)
```

### 4. 结果输出

```python
# 保存详细结果
df.to_csv(output_file, index=False, encoding='utf-8-sig')

# 生成统计报告
report = {
    'analysis_time': datetime.now().isoformat(),
    'analyzer_type': analyzer_type,
    'total_comments': len(df),
    'statistics': stats,
    'sentiment_distribution': sentiment_dist,
    'confidence_analysis': confidence_stats
}
```

## ⚙️ 配置参数

### 1. 分析器配置

```python
# 词典分析器
analyzer = DictionaryBasedAnalyzer()
analyzer.thresholds = {
    'positive': 0.3,
    'negative': -0.3
}

# API分析器
analyzer = AliyunNLPAnalyzer(access_key_id="your_key", access_key_secret="your_secret")
analyzer = BaiduNLPAnalyzer(api_key="your_key", secret_key="your_secret")
analyzer = DeepSeekAnalyzer(api_key="your_key", base_url="https://api.deepseek.com")
```

### 2. 管理器配置

```python
# 创建管理器
manager = SentimentAnalysisManager(
    analyzer_type="dictionary",  # 或 "baidu", "deepseek", "aliyun"
    api_key="your_key",
    secret_key="your_secret"
)
```

### 3. 数据库查询配置

```python
# 时间范围
start_time = datetime.now() - timedelta(days=7)
end_time = datetime.now()

# 平台过滤
platform = "douyin"  # 或 "weibo", "zhihu", "bilibili"

# 数量限制
limit = 1000
```

## 📈 性能优化

### 1. 批量处理

```python
# 分批处理大量数据
batch_size = 100
for i in range(0, len(texts), batch_size):
    batch = texts[i:i+batch_size]
    results.extend(manager.analyze_batch(batch))
```

### 2. 缓存机制

```python
# 百度NLP token缓存
if self.access_token and time.time() < self.token_expire_time:
    return self.access_token
```

### 3. 错误处理

```python
# API调用失败时降级到词典分析
try:
    result = api_analyzer.analyze_sentiment(text)
except Exception as e:
    logger.warning(f"API分析失败，使用词典分析: {e}")
    result = dictionary_analyzer.analyze_sentiment(text)
```

## 🔍 评估指标

### 1. 准确率评估

```python
# 计算各类别准确率
accuracy_metrics = {
    'positive_accuracy': positive_correct / positive_total,
    'negative_accuracy': negative_correct / negative_total,
    'neutral_accuracy': neutral_correct / neutral_total,
    'overall_accuracy': total_correct / total_samples
}
```

### 2. 置信度分析

```python
confidence_analysis = {
    'mean_confidence': df['confidence'].mean(),
    'std_confidence': df['confidence'].std(),
    'high_confidence_ratio': (df['confidence'] > 0.8).mean(),
    'low_confidence_ratio': (df['confidence'] < 0.5).mean()
}
```

### 3. 分布统计

```python
sentiment_distribution = {
    'positive_ratio': positive_count / total_count,
    'negative_ratio': negative_count / total_count,
    'neutral_ratio': neutral_count / total_count
}
```

## 🚀 使用示例

### 1. 基础使用

```python
# 创建分析器
manager = SentimentAnalysisManager("dictionary")

# 分析单个文本
result = manager.analyze_text("这个视频真的很棒！")
print(result)  # {'sentiment': 'positive', 'score': 0.8, 'confidence': 0.85}

# 批量分析
texts = ["很好", "很差", "一般"]
results = manager.analyze_batch(texts)
```

### 2. 数据库分析

```python
# 连接数据库
conn = get_db_conn()

# 分析评论
df = manager.analyze_comments_from_db(
    conn=conn,
    start_time=start_time,
    end_time=end_time,
    limit=1000
)

# 保存结果
manager.save_results(df, "sentiment_results.csv")
manager.generate_report(df, "sentiment_report.json")
```

### 3. API使用

```python
# 使用阿里云NLP
manager = SentimentAnalysisManager(
    "aliyun",
    access_key_id="your_aliyun_access_key_id",
    access_key_secret="your_aliyun_access_key_secret",
    endpoint="nlp.cn-hangzhou.aliyuncs.com"
)

# 使用百度NLP
manager = SentimentAnalysisManager(
    "baidu",
    api_key="your_baidu_api_key",
    secret_key="your_baidu_secret_key"
)

# 使用DeepSeek
manager = SentimentAnalysisManager(
    "deepseek",
    api_key="your_deepseek_api_key"
)
```

## 🐛 常见问题

### 1. API调用失败

**问题**：API密钥无效或网络问题
**解决**：检查API密钥，网络连接，或降级到词典分析

### 2. 情感分类不准确

**问题**：词典覆盖不全或阈值设置不当
**解决**：扩充情感词典，调整分类阈值

### 3. 处理速度慢

**问题**：大量数据或API调用延迟
**解决**：使用批量处理，增加并发，或使用本地词典分析

### 4. 内存占用高

**问题**：大量数据一次性加载
**解决**：分批处理，及时释放内存

## 📝 扩展建议

### 1. 词典扩展

- 添加更多网络用语
- 支持表情符号情感分析
- 增加行业专业词汇

### 2. 算法优化

- 实现深度学习模型
- 支持多语言情感分析
- 增加情感强度细分

### 3. 功能增强

- 支持实时情感分析
- 增加情感趋势分析
- 支持自定义情感分类

## 🔗 相关文档

- [数据清洗算法规则详解](./数据清洗算法规则详解.md)
- [点赞互动分析算法文档](./点赞互动分析算法文档.md)
- [从众心理时间分析功能算法文档](./从众心理时间分析功能算法文档.md)
- [快速使用指南](./快速使用指南.md) 